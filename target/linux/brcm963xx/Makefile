#
# Copyright (C) 2006-2009 OpenWrt.org
#
# This is free software, licensed under the GNU General Public License v2.
# See /LICENSE for more information.
#
include $(TOPDIR)/rules.mk

DEVICE_TYPE=customer

BOARD:=brcm963xx
BOARDNAME:=Broadcom BCM963xx
FEATURES:=usb pci pcmcia

ifeq ($(shell grep CONFIG_BRCM963xx_SDK_VER_412L08 $(TOPDIR)/.config | cut -d'=' -f2),y)
LINUX_VERSION:=2.6.30
else
ifeq ($(shell grep CONFIG_BRCM963xx_SDK_VER_502L04 $(TOPDIR)/.config | cut -d'=' -f2),y)
LINUX_VERSION:=4.1.45
else
LINUX_VERSION:=3.4.11
endif
endif

ifeq ($(CONFIG_BRCM_SDK_VERSION), "416L05")
ifeq ($(CONFIG_BCM416L05_WIFI_VER_7_14_164_23),y)
WIFI_DRIVER_VER:=7_14_164_23
else ifeq ($(CONFIG_BCM416L05_WIFI_VER_7_14_164_20),y)
WIFI_DRIVER_VER:=7_14_164_20_NEW
else ifeq ($(CONFIG_BCM416L05_WIFI_VER_7_14_164_303),y)
WIFI_DRIVER_VER:=7_14_164_303_NEW
else
WIFI_DRIVER_VER:=7_14_164_23
endif
endif


SUBTARGETS:=96838GWOV 963138ref 963269bhr $(filter fmg% vmg% xmg% emg% ,$(shell find * -maxdepth 0 -type d))

include $(INCLUDE_DIR)/target.mk

DEFAULT_PACKAGES=libc libgcc busybox dropbear mtd opkg 

define Target/Description
	Build firmware images for Broadcom based xDSL/routers
	currently supports BCM63138, BCM63168, BCM63268 BCM63169 and BCM63269 based devices.
endef

BROADCOM_SDK_PACKAGE:=broadcom_sdk_$(shell echo $(CONFIG_BRCM_SDK_VERSION))_pkg.tar.bz2
BROADCOM_SDK_DIR:=$(KERNEL_BUILD_DIR)/broadcom-sdk-$(shell echo $(CONFIG_BRCM_SDK_VERSION))

define genMRDinfo
	mkdir -p $(BROADCOM_SDK_DIR)/shared/zyxel
	echo -e "/*\n * This file is auto-generated by OpenWRT if compile BRCM963xx platform.\n * !!! Don't edit it !!!\n */\n" > $(BROADCOM_SDK_DIR)/shared/zyxel/MRD.h
	echo -e "#ifndef _ZYXEL_MRD_H_\n#define _ZYXEL_MRD_H_" >> $(BROADCOM_SDK_DIR)/shared/zyxel/MRD.h
	echo '#define VENDORNAME       $(CONFIG_MRD_VENDOR_NAME)' >> $(BROADCOM_SDK_DIR)/shared/zyxel/MRD.h
	echo '#define PRODUCTNAME      $(CONFIG_MRD_PRODUCT_NAME)' >> $(BROADCOM_SDK_DIR)/shared/zyxel/MRD.h
	echo '#define SERIALNUMBER     $(CONFIG_MRD_SERIAL_NO)' >> $(BROADCOM_SDK_DIR)/shared/zyxel/MRD.h
	echo '#define MAINFEATUREBIT   $(CONFIG_MRD_MAIN_FEATURE_BIT)' >> $(BROADCOM_SDK_DIR)/shared/zyxel/MRD.h
	echo '#define ZYXEL_MODEL_ID   $(CONFIG_MRD_MODEL_ID)' >> $(BROADCOM_SDK_DIR)/shared/zyxel/MRD.h
	echo '#define DEBUGBIT         $(CONFIG_MRD_DEBUG_BIT)' >> $(BROADCOM_SDK_DIR)/shared/zyxel/MRD.h
	echo '#define COUNTRYCODE      $(CONFIG_MRD_COUNTRY_CODE)' >> $(BROADCOM_SDK_DIR)/shared/zyxel/MRD.h
	echo '#define FIRMWARE_VERSION $(CONFIG_ZYXEL_FIRMWARE_VERSION)' >> $(BROADCOM_SDK_DIR)/shared/zyxel/MRD.h
	echo "#endif" >> $(BROADCOM_SDK_DIR)/shared/zyxel/MRD.h
endef

# Special action to support RTK switch
define Kernel/Prepare/RTKSW


endef


ifeq ("$(CONFIG_BRCM963xx_SDK_VER_502L04)", "y")
INC_DIR:=include/uapi
else
INC_DIR:=include
endif

KERNEL_INCLUDE_LINK_NAME := bcm_local_kernel_include
KERNEL_MIPS_INCLUDE_LINK_NAME := bcm_local_kernel_mips_include
KERNEL_ARM_INCLUDE_LINK_NAME := bcm_local_kernel_arm_include
KERNEL_INCLUDE_LINK := $(KERNEL_BUILD_DIR)/$(KERNEL_INCLUDE_LINK_NAME)
KERNEL_MIPS_INCLUDE_LINK := $(KERNEL_BUILD_DIR)/$(KERNEL_MIPS_INCLUDE_LINK_NAME)
KERNEL_ARM_INCLUDE_LINK := $(KERNEL_BUILD_DIR)/$(KERNEL_ARM_INCLUDE_LINK_NAME)

define Kernel/Prepare/BCM
	bzcat $(DL_DIR)/$(BROADCOM_SDK_PACKAGE) | /bin/tar -C $(KERNEL_BUILD_DIR)/ -xf -
endef


define Kernel/Prepare
	$(call Kernel/Prepare/BCM)
	$(call Kernel/Prepare/RTKSW)
	if [ ! -f  $(BROADCOM_SDK_DIR)/targets/$(BCM_PROFILE)/$(BCM_PROFILE) ]; then mkdir -p $(BROADCOM_SDK_DIR)/targets/$(BCM_PROFILE)/ ; fi
	$(TOPDIR)/scripts/genBrcmProfile.sh $(TOPDIR)/.config $(BROADCOM_SDK_DIR)/targets/$(BCM_PROFILE)/$(BCM_PROFILE) $(CONFIG_BRCM_SDK_VERSION)
	echo "$(BCM_PROFILE)" > $(BROADCOM_SDK_DIR)/.last_profile
	$(call genMRDinfo)
	ln -s -f $(LINUX_DIR)/$(INC_DIR) $(KERNEL_INCLUDE_LINK);
ifneq ($(CONFIG_mips),)
	ln -s -f $(LINUX_DIR)/arch/mips/$(INC_DIR) $(KERNEL_MIPS_INCLUDE_LINK);
else
	ln -s -f $(LINUX_DIR)/arch/arm/$(INC_DIR) $(KERNEL_ARM_INCLUDE_LINK);
endif
	$(call Kernel/Prepare/Default)
endef


define prepareWlConfig
endef

define Kernel/Configure
	$(call Kernel/Configure/Default)
ifeq ("$(CONFIG_BRCM963xx_SDK_VER_502L04)", "y")
	make -C $(BROADCOM_SDK_DIR) bcmdrivers_autogen
	make -C $(BROADCOM_SDK_DIR) rdp_link
	make -C $(BROADCOM_SDK_DIR) generate_cms_dmp_flags_h
	make -C $(BROADCOM_SDK_DIR) dtbs
	$(call prepareWlConfig)
endif

endef

$(eval $(call BuildTarget))
